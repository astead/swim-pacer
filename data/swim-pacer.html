<!DOCTYPE html>
<html>
<head>
<title>Swim Pacer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
</head>
<body><div class="container">
        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('main')">Swim Pacer</button>
            <button class="nav-tab" onclick="showPage('coach')">Coach Config</button>
            <button class="nav-tab" onclick="showPage('advanced')">Advanced</button>
        </div>

        <!-- Main Pacer Page -->
        <div id="main" class="page active">
            <!-- Lane Selector (shown when multiple lanes configured) -->
            <div id="laneSelector" style="margin: 15px 0;">
                <div class="control">
                    <select id="currentLane" onchange="updateCurrentLane()">
                        <!-- Options populated by JavaScript -->
                    </select>
                </div>
            </div>

            <!-- Number of Swimmers (lane-specific configuration) -->
            <div class="control" style="margin: 15px 0;">
                <div class="control-row" style="margin-bottom: 5px;">
                    <label for="numSwimmers">Number of Swimmers:</label>
                    <select id="numSwimmers" onchange="updateNumSwimmers()" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px; width: 60px;">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                    <!-- Reset swimmers position button: resets swimmer positions/directions to starting wall for selected lane -->
                    <button id="resetPositionsBtn" class="compact-button push-right" onclick="resetLanePositions()" title="Reset swimmers to starting wall">Reset Position</button>
                </div>
            </div>

            <!-- Collapsible: Queue area -->
            <div style="margin: 10px 0;">
                <div class="toggle-container" style="padding:0;">
                    <h3 style="margin: 0; width:100%; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:700;color:#333;cursor:pointer;display:flex;align-items:center;gap:8px;" onclick="toggleSection('queueArea','queueToggleBtn')">
                            Swim Set Queue
                            <span id="queueToggleBtn" style="transform:rotate(0deg);transition:transform 0.18s;">▾</span>
                        </span>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button id="saveQueueBtn" style="padding:4px 12px; font-size:13px; display:none;" onclick="openSaveDialog();">Save</button>
                            <button id="openQueueBtn" style="padding:4px 12px; font-size:13px;" onclick="openLoadDialog();">Open</button>
                        </div>
                    </h3>
                </div>
                <div id="queueArea" class="underwater-controls" style="display:block;margin-top:8px;padding:10px;">
                    <div id="queueDisplay" style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <div id="queueList" style="font-size: 14px;">
                            <div style="color: #666; font-style: italic;">No sets queued</div>
                        </div>
                    </div>

                    <div id="detailedStatus" style="display: none; margin-top:8px;"></div>

                    <div>
                        <div class="button-group" id="pacerButtons" style="display: none;">
                            <div style="display:flex; gap:8px; margin-bottom:8px; justify-content:center; align-items:center;">
                                <button id="copyLeftBtn" style="padding:4px 12px; font-size:13px; min-width:100px; visibility:hidden;" onclick="copyLeft()">Copy left</button>
                                <button id="repeatBtn" style="padding:4px 12px; font-size:13px; min-width:100px;" onclick="repeatQueue()">Repeat</button>
                                <button id="copyRightBtn" style="padding:4px 12px; font-size:13px; min-width:100px; visibility:hidden;" onclick="copyRight()">Copy right</button>
                            </div>
                            <button class="big-button" id="startBtn">Start Queue</button>
                            <button class="big-button" id="stopBtn" style="display: none; background: #dc3545;">Stop</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collapsible: Create/Edit Set area -->
            <div style="margin: 10px 0;">
                <div class="toggle-container" style="padding:0;">
                    <div style="display:flex; align-items:center; gap:12px; width:100%">
                        <div class="create-tabs" style="display:flex; gap:6px;">
                            <button id="createDetailsTab" class="tab small active" onclick="setCreateTab('details')">Swim Set Details</button>
                            <button id="createSwimmersTab" class="tab small" onclick="setCreateTab('swimmers')">Swimmer Customizations</button>
                        </div>
                    </div>
                </div>
                <div id="createArea" class="underwater-controls" style="margin-top:8px;padding:10px;">

                    <!-- Configuration Controls -->
                    <div id="configControls">
                        <div class="control">
                            <label for="numRounds">Rounds:</label>
                            <div>
                                <input type="number" id="numRounds" min="1" max="20" step="1" value="10" oninput="updateNumRounds()" class="compact-input">
                                <span></span>
                            </div>
                        </div>

                        <div class="control">
                            <label for="swimDistance">Distance:</label>
                            <div>
                                <input type="number" id="swimDistance" min="5" max="1000" step="5" value="50" onchange="updateSwimDistance()" class="compact-input">
                                <span id="distanceUnits">yards</span>
                            </div>
                        </div>

                        <div class="control">
                            <label for="swimTime">Swim time:</label>
                            <div>
                                <input type="text" id="swimTime" value="30" oninput="updateSwimTime()" class="compact-input" placeholder="30 or 1:30">
                                <span id="swimTimeLabel">min:sec or sec</span>
                            </div>
                        </div>

                        <div class="control">
                            <label for="restTime">Rest Time:</label>
                            <div>
                                <input type="number" id="restTime" min="0" step="1" value="10" oninput="updateRestTime()" class="compact-input">
                                <span id="restTimeLabel">min:sec or sec</span>
                            </div>
                        </div>

                        <div class="control">
                            <label for="swimmerInterval">Delay between swimmers:</label>
                            <div>
                                <input type="number" id="swimmerInterval" min="0" max="300" step="1" value="4" oninput="updateSwimmerInterval()" class="compact-input">
                                <span id="swimmerIntervalLabel">min:sec or sec</span>
                            </div>
                        </div>
                    </div>

                    <!-- Swimmer Set Display -->
                    <div id="swimmerSet" style="display: none; margin-top:8px;">
                        <div id="setDetails" style="font-size: 16px; font-weight: bold; margin: 10px 0; padding: 10px; background: #f0f8ff; border-radius: 5px;"></div>
                        <div id="swimmerList"></div>
                    </div>

                    <div class="control" style="margin-top:10px;">
                        <div style="display:flex;gap:8px;flex-wrap:wrap;">
                            <div class="button-group" id="queueButtons">
                                <button class="big-button" onclick="queueSwimSet()" id="queueBtn">Queue Set</button>
                            </div>
                            <div class="button-group" id="editButtons" style="display: none;">
                                <button class="big-button" onclick="saveSwimSet()" id="saveBtn">Save Changes</button>
                                <button class="big-button" onclick="cancelEdit()" id="cancelEditBtn" style="background: #dc3545;">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coach Config Page -->
        <div id="coach" class="page">
            <h3>Swim Settings</h3>

            <div class="toggle-container">
                <h3 style="margin: 0;">Delay Indicators</h3>
                <div class="toggle-labels">
                    <span class="toggle-label" id="delayIndicatorOff">OFF</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="delayIndicatorsEnabled" checked onchange="updateDelayIndicatorsEnabled()">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label active" id="delayIndicatorOn">ON</span>
                    <small style="color: #666; margin-left: 10px; font-size: 12px;">max 5 seconds</small>
                </div>
            </div>

            <div class="toggle-container" style="margin-top: 20px;">
                <h3 style="margin: 0;">Underwaters</h3>
                <div class="toggle-labels">
                    <span class="toggle-label active" id="toggleOff">OFF</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="underwatersEnabled" onchange="updateUnderwatersEnabled(true)">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label" id="toggleOn">ON</span>
                </div>
            </div>

            <div id="underwatersControls" class="underwater-controls" style="display: none;">
                <div class="control">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <label for="lightSize" style="margin:0; white-space:nowrap;">Light pulse size:</label>
                        <input type="number" id="lightSize" min="0.1" max="10" step="0.1" value="1.0" onchange="updateLightSize()" class="compact-input">
                        <span id="lightSizeUnit">ft</span>
                    </div>
                </div>

                <div class="control">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <label for="firstUnderwaterDistance" style="margin:0; white-space:nowrap;">First underwater distance:</label>
                        <input type="number" id="firstUnderwaterDistance" min="1" max="50" step="1" value="1" onchange="updateFirstUnderwaterDistance()" class="compact-input">
                        <span id="firstUnderwaterDistanceUnit">ft</span>
                    </div>
                </div>

                <div class="control">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <label for="underwaterDistance" style="margin:0; white-space:nowrap;">Underwater distance:</label>
                        <input type="number" id="underwaterDistance" min="1" max="50" step="1" value="1" onchange="updateUnderwaterDistance()" class="compact-input">
                        <span id="underwaterDistanceUnit">ft</span>
                    </div>
                </div>

                <div class="control">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <label for="hideAfter" style="margin:0; white-space:nowrap;">Hide after:</label>
                        <input type="number" id="hideAfter" min="1" max="60" step="1" value="1" onchange="updateHideAfter()" class="compact-input">
                        <span id="hideAfterUnit">seconds</span>
                    </div>
                </div>

                <div class="control">
                    <div class="color-selection-row" style="display: flex; align-items: center; gap: 10px;">
                        <div class="color-indicator" id="underwaterColorIndicator"
                             style="width: 30px; height: 30px; border-radius: 50%; background-color: #0000ff; border: 2px solid #ccc; cursor: pointer;"
                             onclick="openColorPickerForUnderwater()"></div>
                        <label>Underwater Color</label>
                    </div>
                </div>

                <div class="control">
                    <div class="color-selection-row" style="display: flex; align-items: center; gap: 10px;">
                        <div class="color-indicator" id="surfaceColorIndicator"
                             style="width: 30px; height: 30px; border-radius: 50%; background-color: #00ff00; border: 2px solid #ccc; cursor: pointer;"
                             onclick="openColorPickerForSurface()"></div>
                        <label>Surface Color</label>
                    </div>
                </div>
            </div>

            <h3>Light Settings</h3>
            <div class="control">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <label for="brightness">Brightness:</label>
                    <span id="brightnessValue">40%</span>
                </div>
                <input type="range" id="brightness" min="0" max="100" value="40" oninput="updateBrightness()">
            </div>

            <div class="control">
                <div style="display:flex; align-items:center; gap:8px;">
                    <label for="pulseWidth" style="margin:0; white-space:nowrap;">Light pulse size:</label>
                    <input type="number" id="pulseWidth" min="0.1" max="10" step="0.1" value="1.0" onchange="updatePulseWidth()" class="compact-input">
                    <span id="pulseWidthUnit">ft</span>
                </div>
            </div>

            <div class="control">
                <label>Swimmer Colors:</label>
                <div style="margin-top: 10px;">
                    <div id="individualColorsRow" style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; padding: 8px; border-radius: 5px;" onclick="selectIndividualColors()">
                        <div id="individualColorsIcon" style="width: 30px; height: 30px; border: 2px solid #333; border-radius: 50%; position: relative; flex-shrink: 0; min-width: 30px; min-height: 30px; overflow: hidden;">
                            <div style="position: absolute; top: 0; left: 0; width: 50%; height: 50%; background-color: #ff0000;"></div>
                            <div style="position: absolute; top: 0; right: 0; width: 50%; height: 50%; background-color: #00ff00;"></div>
                            <div style="position: absolute; bottom: 0; left: 0; width: 50%; height: 50%; background-color: #0000ff;"></div>
                            <div style="position: absolute; bottom: 0; right: 0; width: 50%; height: 50%; background-color: #ffff00;"></div>
                        </div>
                        <input type="radio" id="individualColors" name="colorMode" value="individual" checked onchange="updateColorMode()" style="display: none;">
                        <label for="individualColors" style="margin: 0; margin-left: 8px; cursor: pointer;">Individual colors</label>
                    </div>
                    <div id="sameColorRow" style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; padding: 8px; border-radius: 5px;">
                        <div id="colorIndicator" class="swimmer-color" style="background-color: #0000ff; cursor: pointer; flex-shrink: 0; min-width: 30px; min-height: 30px;" onclick="selectSameColorAndOpenPicker(event)"></div>
                        <input type="radio" id="sameColor" name="colorMode" value="same" onchange="updateColorMode()" style="display: none;">
                        <label for="sameColor" style="margin: 0; margin-left: 8px; cursor: pointer;" onclick="selectSameColor()">Same color</label>
                    </div>
                    <div id="colorPickerSection" style="display: none; margin-top: 10px; margin-left: 24px;">
                        <input type="color" id="swimmerColorPicker" value="#0000ff" onchange="updateSwimmerColor()" style="opacity: 0; pointer-events: none;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Page -->
        <div id="advanced" class="page">
            <div class="control" style="display:flex; align-items:center; gap:12px;">
                <label for="poolLength" style="min-width:180px; margin:0;">Pool Length:</label>
                <input type="number" id="poolLength" min="1" max="1000" step="1" value="25" onchange="updateCalculations()" class="compact-input">
                <select id="poolLengthUnits" onchange="updateCalculations()" class="compact-input" style="width:100px;">
                    <option value="yards">yards</option>
                    <option value="meters">meters</option>
                </select>
            </div>

            <div class="control" style="display:flex; align-items:center; gap:12px;">
                <label for="stripLengthMeters" style="min-width:180px; margin:0;">LED Strip Length:</label>
                <input type="number" id="stripLengthMeters" value="5" min="1" max="50" step="0.5" onchange="updateCalculations()" class="compact-input">
                <span id="stripLengthMetersLabel">meters</span>
            </div>

            <div class="control" style="display:flex; align-items:center; gap:12px;">
                <label for="ledsPerMeter" style="min-width:180px; margin:0;">LEDs per Meter:</label>
                <input type="number" id="ledsPerMeter" value="30" min="10" max="144" onchange="updateCalculations()" class="compact-input">
                <span></span>
            </div>

            <div class="control">
                <label for="numLedStrips">Number of LED strips per lane:</label>
                <div id="numLedStripsList">
                    <!-- Number of strip inputs populated by JavaScript -->
                </div>
            </div>

            <div class="control" style="display:flex; align-items:center; gap:12px;">
                <label for="gapBetweenStrips" style="min-width:180px; margin:0;">Gap between strips:</label>
                <input type="number" id="gapBetweenStrips" value="1" min="1" max="10" onchange="updateCalculations()" class="compact-input">
                <span id="gapBetweenStripsLabel">cm</span>
            </div>

            <div class="control" style="display:flex; align-items:center; gap:12px;">
                <label for="numLanes" style="min-width:180px; margin:0;">Number of lanes:</label>
                <input type="number" id="numLanes" value="2" min="1" max="4" onchange="updateNumLanes()" class="compact-input">
            </div>

            <!-- Lane Names Management -->
            <div id="laneNamesSection" style="margin-top: 20px;">
                <div>
                    <div style="margin: 10px 0;">
                        <h4 style="margin: 0; color: #333; display: inline-block;">Lane Names:</h4>
                        <span id="identifyLanesBtn" onclick="toggleLaneIdentification()" style="display: inline-block; margin-left: 10px; padding: 2px 6px; font-size: 12px; border: 1px solid #007bff; border-radius: 3px; background: #007bff; color: white; cursor: pointer; font-weight: 500; white-space: nowrap; user-select: none;">Identify Lanes</span>
                    </div>
                    <div id="laneNamesList">
                        <!-- Lane name inputs populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Color Picker Modal (Global) -->
    <div id="customColorPicker" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;" onclick="closeColorPicker()">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
            <h4 style="margin: 0 0 15px 0; text-align: center;">Choose Color</h4>
            <div id="colorGrid" style="display: grid; grid-template-columns: repeat(6, 40px); gap: 8px; margin-bottom: 15px;">
                <!-- Colors will be populated by JavaScript -->
            </div>
            <button onclick="closeColorPicker()" style="width: 100%; padding: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
        </div>
    </div>

    <!-- Repeat modal: choose start index, contiguous length and iterations -->
    <div id="repeatModal" class="modal" style="display:none;">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="repeatModalTitle">
            <h3 id="repeatModalTitle">Create Repeat block</h3>
            <div id="repeatModalBody" style="max-height:320px; overflow:auto; margin-top:8px;"></div>
            <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                <label style="min-width:120px;">Iterations</label>
                <input id="repeatIterations" type="number" min="1" value="1" style="width:80px;">
            </div>
            <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
                <button onclick="hideRepeatModal()">Cancel</button>
                <button onclick="repeatModalConfirm()">Create Repeat</button>
            </div>
        </div>
    </div>
    <!-- end repeat modal -->

    <!-- Load Saved Queue Modal -->
    <div id="loadModal" class="modal" style="display:none;">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="loadModalTitle">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <h3 id="loadModalTitle" style="margin:0;">Load Saved Queue</h3>
                <button id="uploadQueueBtn" onclick="triggerQueueUpload()" style="padding:4px 12px; font-size:12px; width:70px; background:#007bff; color:white;">Upload</button>
            </div>
            <input type="file" id="queueFileInput" accept=".json" style="display:none;" onchange="handleQueueFileUpload(event)">
            <div id="loadModalBody" style="max-height:320px; overflow:auto; margin-top:8px;"></div>
            <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
                <button onclick="hideLoadModal()">Cancel</button>
                <button id="loadModalOk" onclick="loadModalConfirm()">Load</button>
            </div>
        </div>
    </div>
    <!-- end load modal -->

    <script src="script.js"></script>
</body>
</html>
