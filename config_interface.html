<!-- ========== SYNC MARKER: START ESP32 HTML ========== -->
<!-- This HTML content is synchronized with swim_pacer.ino handleRoot() function -->
<!-- When editing, ensure both files stay identical between sync markers -->
<!DOCTYPE html>
<html>
<head>
    <title>Swim Pacer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial; margin: 20px; background: #f0f0f0; }
        .container { background: white; padding: 20px; border-radius: 10px; max-width: 500px; margin: 0 auto; }
        .control { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, button, select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        button { background: #007bff; color: white; cursor: pointer; margin: 5px 0; }
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #545b62; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .running { background: #d4edda; color: #155724; }
        .stopped { background: #f8d7da; color: #721c24; }
        .color-preview { width: 50px; height: 30px; border: 1px solid #ccc; display: inline-block; margin-left: 10px; }

        /* Navigation */
        .nav-tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #dee2e6; }
        .nav-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #f8f9fa; border: none; border-bottom: 3px solid transparent; color: #495057; }
        .nav-tab.active { background: white; border-bottom-color: #007bff; color: #007bff; font-weight: bold; }
        .nav-tab:hover { background: #e9ecef; color: #495057; }

        /* Page content */
        .page { display: none; }
        .page.active { display: block; }

        /* Main page specific */
        .big-button { font-size: 18px; padding: 15px; margin: 10px 0; }
        .color-wheel { display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
        .color-option { width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; }
        .color-option.selected { border-color: #333; }

        .calculated-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('main')">Swim Pacer</button>
            <button class="nav-tab" onclick="showPage('coach')">Coach Config</button>
            <button class="nav-tab" onclick="showPage('advanced')">Advanced</button>
        </div>

        <!-- Main Pacer Page -->
        <div id="main" class="page active">
            <div class="status stopped" id="status">Pacer Stopped</div>

            <div class="control">
                <button class="big-button" onclick="togglePacer()" id="toggleBtn">Start Pacer</button>
            </div>

            <div class="control">
                <label for="pacePer50">Target Pace (seconds per 50 yards):</label>
                <input type="number" id="pacePer50" value="30" min="20" max="60" step="0.5" oninput="updateFromPace()">
            </div>

            <div class="control">
                <label>LED Color:</label>
                <div class="color-wheel">
                    <div class="color-option selected" style="background: red;" onclick="selectColor('red')" data-color="red"></div>
                    <div class="color-option" style="background: green;" onclick="selectColor('green')" data-color="green"></div>
                    <div class="color-option" style="background: blue;" onclick="selectColor('blue')" data-color="blue"></div>
                    <div class="color-option" style="background: yellow;" onclick="selectColor('yellow')" data-color="yellow"></div>
                    <div class="color-option" style="background: purple;" onclick="selectColor('purple')" data-color="purple"></div>
                    <div class="color-option" style="background: cyan;" onclick="selectColor('cyan')" data-color="cyan"></div>
                    <div class="color-option" style="background: white; border: 1px solid #ccc;" onclick="selectColor('white')" data-color="white"></div>
                </div>
            </div>
        </div>
        
        <!-- Coach Config Page -->
        <div id="coach" class="page">
            <h2>Coach Configuration</h2>
            <p>Adjust display settings and apply changes. Use the Main Pacer page to set pace.</p>

            <div class="control">
                <label for="brightness">Brightness:</label>
                <input type="range" id="brightness" min="20" max="255" value="150" oninput="updateBrightness()">
                <span id="brightnessValue">150</span>
            </div>

            <div class="control">
                <label for="pulseWidth">Pulse Width (feet):</label>
                <input type="range" id="pulseWidth" min="0.5" max="5" step="0.5" value="1.0" oninput="updatePulseWidth()">
                <span id="pulseWidthValue">1.0</span>
            </div>

            <div class="control">
                <button onclick="applyPaceSettings()">Apply Settings</button>
            </div>
        </div>

        <!-- Advanced Page -->
        <div id="advanced" class="page">
            <h2>Advanced Settings</h2>
            <p>Configure LED strip and pool dimensions. The pulse timing accounts for pool vs. strip length differences.</p>

            <div class="control">
                <label for="poolLength">Pool Length:</label>
                <select id="poolLength" onchange="updateCalculations()">
                    <option value="25">25 yards</option>
                    <option value="50">50 yards</option>
                    <option value="25m">25 meters</option>
                    <option value="50m">50 meters</option>
                </select>
            </div>

            <div class="control">
                <label for="stripLength">LED Strip Length (meters):</label>
                <input type="number" id="stripLength" value="23" min="1" max="50" step="0.5" onchange="updateCalculations()">
            </div>

            <div class="control">
                <label for="ledsPerMeter">LEDs per Meter:</label>
                <input type="number" id="ledsPerMeter" value="30" min="10" max="144" onchange="updateCalculations()">
            </div>

            <div class="calculated-info">
                <div><strong>Total LEDs:</strong> <span id="totalLeds">690</span></div>
                <div><strong>Pool Length:</strong> <span id="poolLengthDisplay">25 yards (22.9m)</span></div>
                <div><strong>Strip covers:</strong> <span id="stripCoverage">100.4% of pool</span></div>
            </div>

            <div class="control">
                <button onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        let currentSettings = {
            speed: 5.0,
            color: 'red',
            brightness: 150,
            pulseWidth: 1.0,
            poolLength: '25',
            stripLength: 23,
            ledsPerMeter: 30,
            isRunning: false
        };

        // Page navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

            // Show selected page
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
        }

        // Conversion functions for swimming
        function paceToSpeed(paceSeconds, poolYards = 50) {
            const poolFeet = poolYards * 3; // Convert yards to feet
            return poolFeet / paceSeconds;
        }

        function speedToPace(speedFps, poolYards = 50) {
            const poolFeet = poolYards * 3; // Convert yards to feet
            return poolFeet / speedFps;
        }

        function updateFromPace() {
            const pace = parseFloat(document.getElementById('pacePer50').value);
            const speed = paceToSpeed(pace);
            currentSettings.speed = speed;

            updateCalculations();
        }

        function updateCalculations() {
            const poolLength = document.getElementById('poolLength').value;
            const stripLength = parseFloat(document.getElementById('stripLength').value);
            const ledsPerMeter = parseInt(document.getElementById('ledsPerMeter').value);
            
            // Convert pool length to meters
            let poolLengthMeters;
            let poolDisplay;
            if (poolLength.endsWith('m')) {
                poolLengthMeters = parseFloat(poolLength);
                poolDisplay = poolLength + ` (${(poolLengthMeters * 1.094).toFixed(1)} yards)`;
            } else {
                // Yards to meters
                poolLengthMeters = parseInt(poolLength) * 0.9144;
                poolDisplay = poolLength + ` yards (${poolLengthMeters.toFixed(1)}m)`;
            }
            
            // Calculate total LEDs
            const totalLeds = Math.round(stripLength * ledsPerMeter);
            
            // Calculate coverage
            const coverage = ((stripLength / poolLengthMeters) * 100).toFixed(1);
            
            // Update displays
            document.getElementById('totalLeds').textContent = totalLeds;
            document.getElementById('poolLengthDisplay').textContent = poolDisplay;
            document.getElementById('stripCoverage').textContent = coverage + '% of pool';
            
            // Update current settings
            currentSettings.poolLength = poolLength;
            currentSettings.stripLength = stripLength;
            currentSettings.ledsPerMeter = ledsPerMeter;
        }

        function selectColor(color) {
            currentSettings.color = color;
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`[data-color="${color}"]`).classList.add('selected');
            updateSettings();
        }

        function updateBrightness() {
            const brightness = document.getElementById('brightness').value;
            currentSettings.brightness = parseInt(brightness);
            document.getElementById('brightnessValue').textContent = brightness;
            updateSettings();
        }

        function updatePulseWidth() {
            const pulseWidth = document.getElementById('pulseWidth').value;
            currentSettings.pulseWidth = parseFloat(pulseWidth);
            document.getElementById('pulseWidthValue').textContent = pulseWidth;
            updateSettings();
        }

        function togglePacer() {
            currentSettings.isRunning = !currentSettings.isRunning;
            
            // Update UI immediately for better responsiveness
            const status = currentSettings.isRunning ? "Pacer Started" : "Pacer Stopped";
            document.getElementById('status').textContent = status;
            document.getElementById('status').className = 'status ' + (currentSettings.isRunning ? 'running' : 'stopped');
            document.getElementById('toggleBtn').textContent = currentSettings.isRunning ? 'Stop Pacer' : 'Start Pacer';

            // Try to notify server (will fail gracefully in standalone mode)
            fetch('/toggle', { method: 'POST' })
            .then(response => response.text())
            .then(result => {
                // Server responded, update status with server message
                document.getElementById('status').textContent = result;
            })
            .catch(error => {
                // Server not available (standalone mode), keep local status
                console.log('Running in standalone mode - server not available');
            });
        }

        function applyPaceSettings() {
            updateSettings();
            showPage('main');
            // Switch to main tab
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('.nav-tab').classList.add('active');
        }

        function updateSettings() {
            fetch('/setSpeed', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `speed=${currentSettings.speed}`
            }).catch(error => {
                console.log('Speed update - server not available (standalone mode)');
            });

            fetch('/setPulseWidth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `pulseWidth=${currentSettings.pulseWidth}`
            }).catch(error => {
                console.log('Pulse width update - server not available (standalone mode)');
            });

            fetch('/setStripLength', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `stripLength=${currentSettings.stripLength}`
            }).catch(error => {
                console.log('Strip length update - server not available (standalone mode)');
            });

            fetch('/setLedsPerMeter', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `ledsPerMeter=${currentSettings.ledsPerMeter}`
            }).catch(error => {
                console.log('LEDs per meter update - server not available (standalone mode)');
            });
        }

        function saveSettings() {
            updateSettings();

            fetch('/setColor', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `color=${currentSettings.color}`
            }).catch(error => {
                console.log('Color update - server not available (standalone mode)');
            });

            fetch('/setBrightness', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `brightness=${currentSettings.brightness}`
            }).catch(error => {
                console.log('Brightness update - server not available (standalone mode)');
            });

            alert('Settings saved!');
        }

        // Initialize
        updateCalculations();
    </script>
</body>
</html>
<!-- ========== SYNC MARKER: END ESP32 HTML ========== -->