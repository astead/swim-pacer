<!-- ========== SYNC MARKER: START ESP32 HTML ========== -->
<!-- This HTML content is synchronized with swim_pacer.ino handleRoot() function -->
<!-- When editing, ensure both files stay identical between sync markers -->
<!DOCTYPE html>
<html>
<head>
    <title>Swim Pacer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial; margin: 20px; background: #f0f0f0; }
        .container { background: white; padding: 20px; border-radius: 10px; max-width: 500px; margin: 0 auto; }
        .control { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, button, select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        button { background: #007bff; color: white; cursor: pointer; margin: 5px 0; }
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #545b62; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .running { background: #d4edda; color: #155724; }
        .stopped { background: #f8d7da; color: #721c24; }
        .color-preview { width: 50px; height: 30px; border: 1px solid #ccc; display: inline-block; margin-left: 10px; }

        /* Navigation */
        .nav-tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #dee2e6; }
        .nav-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #f8f9fa; border: none; border-bottom: 3px solid transparent; color: #495057; }
        .nav-tab.active { background: white; border-bottom-color: #007bff; color: #007bff; font-weight: bold; }
        .nav-tab:hover { background: #e9ecef; color: #495057; }

        /* Page content */
        .page { display: none; }
        .page.active { display: block; }

        /* Main page specific */
        .big-button { font-size: 18px; padding: 15px; margin: 0; min-width: 140px; }
        .button-group { display: flex; gap: 10px; margin: 10px 0; }
        .color-wheel { display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
        .color-option { width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; }
        .color-option.selected { border-color: #333; }

        /* Swimmer set styles */
        .swimmer-row {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            gap: 15px;
        }
        .swimmer-color {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #333;
            cursor: pointer;
        }
        .swimmer-info {
            flex: 1;
            font-weight: bold;
        }
        .swimmer-pace-input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        /* Toggle Switch Styles */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #2196F3;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .toggle-labels {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }

        .toggle-label {
            transition: color 0.3s;
        }

        .toggle-label.active {
            color: #2196F3;
            font-weight: bold;
        }

        /* Underwater Controls Styling */
        .underwater-controls {
            background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%);
            border: 2px solid #81d4fa;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
        }

        .underwater-controls .control {
            margin: 15px 0;
        }

        .underwater-controls .control:first-child {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPage('main')">Swim Pacer</button>
            <button class="nav-tab" onclick="showPage('coach')">Coach Config</button>
            <button class="nav-tab" onclick="showPage('advanced')">Advanced</button>
        </div>

        <!-- Main Pacer Page -->
        <div id="main" class="page active">
            <div class="status stopped" id="status">Pacer Stopped</div>

            <!-- Detailed Status (shown when running) -->
            <div id="detailedStatus" style="display: none; background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #2196F3;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; color: #1976D2;">Current Status</h4>
                    <div id="elapsedTime" style="font-weight: bold; color: #1976D2;">00:00</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                    <div>
                        <strong>Round:</strong> <span id="currentRound">1</span> of <span id="totalRounds">10</span>
                    </div>
                    <div>
                        <strong>Progress:</strong> <span id="roundProgress">0%</span>
                    </div>
                    <div>
                        <strong>Active Swimmers:</strong> <span id="activeSwimmers">0</span>
                    </div>
                    <div>
                        <strong>Next Event:</strong> <span id="nextEvent">Starting...</span>
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <div style="background: #fff; border-radius: 4px; padding: 8px; font-size: 12px;">
                        <strong>Current Phase:</strong> <span id="currentPhase">Preparing to start</span>
                    </div>
                </div>
            </div>

            <div class="control">
                <div class="button-group">
                    <button class="big-button" onclick="togglePacer()" id="toggleBtn">Start Pacer</button>
                    <button class="big-button" onclick="createSet()" id="createSetBtn">Create Set</button>
                </div>
            </div>

            <!-- Configuration Controls -->
            <div id="configControls">
                <div class="control">
                    <label for="numRounds">Number of Rounds:</label>
                    <input type="number" id="numRounds" min="1" max="20" step="1" value="10" oninput="updateNumRounds()">
                </div>

                <div class="control">
                    <label for="paceDistance">Distance:</label>
                    <select id="paceDistance" onchange="updatePaceDistance()">
                        <option value="25">25 yards</option>
                        <option value="50" selected>50 yards</option>
                        <option value="75">75 yards</option>
                        <option value="100">100 yards</option>
                        <option value="200">200 yards</option>
                        <option value="500">500 yards</option>
                    </select>
                </div>

                <div class="control">
                    <label for="pacePer50">Pace (seconds per <span id="paceDistanceLabel">50 yards</span>):</label>
                    <input type="number" id="pacePer50" value="30" min="20" max="300" step="0.5" oninput="updateFromPace()">
                </div>

                <div class="control">
                    <label for="restTime">Rest Time (seconds):</label>
                    <input type="range" id="restTime" min="0" max="30" step="1" value="5" oninput="updateRestTime()">
                    <span id="restTimeValue">5</span>
                </div>

                <div class="control">
                    <label for="numSwimmers">Number of Swimmers:</label>
                    <input type="range" id="numSwimmers" min="1" max="6" step="1" value="3" oninput="updateNumSwimmers()">
                    <span id="numSwimmersValue">3</span>
                </div>
            </div>

            <!-- Swimmer Set Display -->
            <div id="swimmerSet" style="display: none;">
                <h3>Swim Set</h3>
                <div id="setDetails" style="font-size: 16px; font-weight: bold; margin: 10px 0; padding: 10px; background: #f0f8ff; border-radius: 5px;"></div>
                <div id="swimmerList"></div>
            </div>
        </div>

        <!-- Coach Config Page -->
        <div id="coach" class="page">
            <h3>Swim Settings</h3>
            <div class="control">
                <label for="initialDelay">Initial delay (seconds):</label>
                <input type="range" id="initialDelay" min="0" max="30" step="1" value="10" oninput="updateInitialDelay()">
                <span id="initialDelayValue">10</span>
            </div>
            <div class="control">
                <label for="swimmerInterval">Delay between swimmers (seconds):</label>
                <input type="range" id="swimmerInterval" min="1" max="20" step="1" value="4" oninput="updateSwimmerInterval()">
                <span id="swimmerIntervalValue">4</span>
            </div>

            <div class="toggle-container">
                <h3 style="margin: 0;">Underwaters</h3>
                <div class="toggle-labels">
                    <span class="toggle-label active" id="toggleOff">OFF</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="underwatersEnabled" onchange="updateUnderwatersEnabled()">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label" id="toggleOn">ON</span>
                </div>
            </div>

            <div id="underwatersControls" class="underwater-controls" style="display: none;">
                <div class="control">
                    <label for="lightSize">Light size (feet):</label>
                    <input type="range" id="lightSize" min="0.5" max="5" step="0.5" value="1.0" oninput="updateLightSize()">
                    <span id="lightSizeValue">1.0</span>
                </div>

                <div class="control">
                    <label for="firstUnderwaterDistance">First underwater distance (feet):</label>
                    <input type="range" id="firstUnderwaterDistance" min="1" max="50" step="1" value="20" oninput="updateFirstUnderwaterDistance()">
                    <span id="firstUnderwaterDistanceValue">20</span>
                </div>

                <div class="control">
                    <label for="underwaterDistance">Underwater distance (feet):</label>
                    <input type="range" id="underwaterDistance" min="1" max="50" step="1" value="20" oninput="updateUnderwaterDistance()">
                    <span id="underwaterDistanceValue">20</span>
                </div>

                <div class="control">
                    <label for="hideAfter">Hide after (seconds):</label>
                    <input type="range" id="hideAfter" min="1" max="10" step="1" value="3" oninput="updateHideAfter()">
                    <span id="hideAfterValue">3</span>
                </div>

                <div class="control">
                    <label>Underwater Color:</label>
                    <div class="color-selection-row" style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                        <div class="color-indicator" id="underwaterColorIndicator" 
                             style="width: 30px; height: 30px; border-radius: 50%; background-color: #0000ff; border: 2px solid #ccc; cursor: pointer;"
                             onclick="openColorPickerForUnderwater()"></div>
                        <span>Underwater color</span>
                    </div>
                </div>

                <div class="control">
                    <label>Surface Color:</label>
                    <div class="color-selection-row" style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                        <div class="color-indicator" id="surfaceColorIndicator" 
                             style="width: 30px; height: 30px; border-radius: 50%; background-color: #00ff00; border: 2px solid #ccc; cursor: pointer;"
                             onclick="openColorPickerForSurface()"></div>
                        <span>Surface color</span>
                    </div>
                </div>
            </div>

            <h3>Light Settings</h3>
            <div class="control">
                <label for="brightness">Brightness:</label>
                <input type="range" id="brightness" min="20" max="255" value="150" oninput="updateBrightness()">
                <span id="brightnessValue">150</span>
            </div>

            <div class="control">
                <label for="pulseWidth">Pulse Width (feet):</label>
                <input type="range" id="pulseWidth" min="0.5" max="5" step="0.5" value="1.0" oninput="updatePulseWidth()">
                <span id="pulseWidthValue">1.0</span>
            </div>

            <div class="control">
                <label>Swimmer Colors:</label>
                <div style="margin-top: 10px;">
                    <div id="individualColorsRow" style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; padding: 8px; border-radius: 5px;" onclick="selectIndividualColors()">
                        <div id="individualColorsIcon" style="width: 30px; height: 30px; border: 2px solid #333; border-radius: 50%; position: relative; flex-shrink: 0; min-width: 30px; min-height: 30px; overflow: hidden;">
                            <div style="position: absolute; top: 0; left: 0; width: 50%; height: 50%; background-color: #ff0000;"></div>
                            <div style="position: absolute; top: 0; right: 0; width: 50%; height: 50%; background-color: #00ff00;"></div>
                            <div style="position: absolute; bottom: 0; left: 0; width: 50%; height: 50%; background-color: #0000ff;"></div>
                            <div style="position: absolute; bottom: 0; right: 0; width: 50%; height: 50%; background-color: #ffff00;"></div>
                        </div>
                        <input type="radio" id="individualColors" name="colorMode" value="individual" checked onchange="updateColorMode()" style="display: none;">
                        <label for="individualColors" style="margin: 0; margin-left: 8px; cursor: pointer;">Individual colors</label>
                    </div>
                    <div id="sameColorRow" style="display: flex; align-items: center; margin-bottom: 8px; cursor: pointer; padding: 8px; border-radius: 5px;">
                        <div id="colorIndicator" class="swimmer-color" style="background-color: #0000ff; cursor: pointer; flex-shrink: 0; min-width: 30px; min-height: 30px;" onclick="selectSameColorAndOpenPicker(event)"></div>
                        <input type="radio" id="sameColor" name="colorMode" value="same" onchange="updateColorMode()" style="display: none;">
                        <label for="sameColor" style="margin: 0; margin-left: 8px; cursor: pointer;" onclick="selectSameColor()">Same color</label>
                    </div>
                    <div id="colorPickerSection" style="display: none; margin-top: 10px; margin-left: 24px;">
                        <input type="color" id="swimmerColorPicker" value="#0000ff" onchange="updateSwimmerColor()" style="opacity: 0; pointer-events: none;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Page -->
        <div id="advanced" class="page">
            <div class="control">
                <label for="poolLength">Pool Length:</label>
                <select id="poolLength" onchange="updateCalculations()">
                    <option value="25">25 yards</option>
                    <option value="50">50 yards</option>
                    <option value="25m">25 meters</option>
                    <option value="50m">50 meters</option>
                </select>
            </div>

            <div class="control">
                <label for="stripLength">LED Strip Length (meters):</label>
                <input type="number" id="stripLength" value="23" min="1" max="50" step="0.5" onchange="updateCalculations()">
            </div>

            <div class="control">
                <label for="ledsPerMeter">LEDs per Meter:</label>
                <input type="number" id="ledsPerMeter" value="30" min="10" max="144" onchange="updateCalculations()">
            </div>
        </div>
    </div>

    <!-- Custom Color Picker Modal (Global) -->
    <div id="customColorPicker" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;" onclick="closeColorPicker()">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
            <h4 style="margin: 0 0 15px 0; text-align: center;">Choose Color</h4>
            <div id="colorGrid" style="display: grid; grid-template-columns: repeat(6, 40px); gap: 8px; margin-bottom: 15px;">
                <!-- Colors will be populated by JavaScript -->
            </div>
            <button onclick="closeColorPicker()" style="width: 100%; padding: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
        </div>
    </div>

    <script>
        let currentSettings = {
            speed: 5.0,
            color: 'red',
            brightness: 150,
            pulseWidth: 1.0,
            restTime: 5,
            paceDistance: 50,
            initialDelay: 10,
            swimmerInterval: 4,
            numSwimmers: 3,
            numRounds: 10,
            colorMode: 'individual',
            swimmerColor: '#0000ff',
            poolLength: '25',
            stripLength: 23,
            ledsPerMeter: 30,
            isRunning: false,
            underwatersEnabled: false,
            lightSize: 1.0,
            firstUnderwaterDistance: 20,
            underwaterDistance: 20,
            hideAfter: 3,
            underwaterColor: '#0000ff',
            surfaceColor: '#00ff00'
        };

        // Swimmer set configuration
        let swimmerSet = [];
        let currentSwimmerIndex = -1; // Track which swimmer is being edited
        const swimmerColors = ['red', 'green', 'blue', 'yellow', 'purple', 'cyan'];
        const colorHex = {
            'red': '#ff0000',
            'green': '#00ff00',
            'blue': '#0000ff',
            'yellow': '#ffff00',
            'purple': '#800080',
            'cyan': '#00ffff',
            'custom': '#0000ff' // Default custom color
        };

        // Convert hex color to color name for swimmer assignment
        function hexToColorName(hexColor) {
            // Check if it matches any existing colors
            for (const [colorName, colorValue] of Object.entries(colorHex)) {
                if (colorValue.toLowerCase() === hexColor.toLowerCase()) {
                    return colorName;
                }
            }
            // If no match found, update custom color and return 'custom'
            colorHex.custom = hexColor;
            return 'custom';
        }

        // Page navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

            // Show selected page
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
        }

        // Conversion functions for swimming
        function paceToSpeed(paceSeconds, poolYards = 50) {
            const poolFeet = poolYards * 3; // Convert yards to feet
            return poolFeet / paceSeconds;
        }

        function speedToPace(speedFps, poolYards = 50) {
            const poolFeet = poolYards * 3; // Convert yards to feet
            return poolFeet / speedFps;
        }

        function updateFromPace() {
            const pace = parseFloat(document.getElementById('pacePer50').value);
            const paceDistance = currentSettings.paceDistance;
            // Convert pace to speed (feet per second) based on selected distance
            const distanceFeet = paceDistance * 3; // yards to feet
            const speed = distanceFeet / pace;
            currentSettings.speed = speed;

            updateCalculations();
        }

        function updatePaceDistance() {
            const paceDistance = parseInt(document.getElementById('paceDistance').value);
            currentSettings.paceDistance = paceDistance;

            // Update the pace label
            document.getElementById('paceDistanceLabel').textContent = paceDistance + ' yards';

            // Recalculate speed based on current pace input and new distance
            updateFromPace();
            updateSettings();
        }

        function updateCalculations() {
            const poolLength = document.getElementById('poolLength').value;
            const stripLength = parseFloat(document.getElementById('stripLength').value);
            const ledsPerMeter = parseInt(document.getElementById('ledsPerMeter').value);

            // Update current settings
            currentSettings.poolLength = poolLength;
            currentSettings.stripLength = stripLength;
            currentSettings.ledsPerMeter = ledsPerMeter;

            // Apply changes immediately
            updateSettings();
        }

        function updateBrightness() {
            const brightness = document.getElementById('brightness').value;
            currentSettings.brightness = parseInt(brightness);
            document.getElementById('brightnessValue').textContent = brightness;
            updateSettings();
        }

        function updatePulseWidth() {
            const pulseWidth = document.getElementById('pulseWidth').value;
            currentSettings.pulseWidth = parseFloat(pulseWidth);
            document.getElementById('pulseWidthValue').textContent = pulseWidth;
            updateSettings();
        }

        function updateRestTime() {
            const restTime = document.getElementById('restTime').value;
            currentSettings.restTime = parseInt(restTime);
            document.getElementById('restTimeValue').textContent = restTime;
            updateSettings();
        }

        function updateInitialDelay() {
            const initialDelay = document.getElementById('initialDelay').value;
            currentSettings.initialDelay = parseInt(initialDelay);
            document.getElementById('initialDelayValue').textContent = initialDelay;
            updateSettings();
        }

        function updateSwimmerInterval() {
            const swimmerInterval = document.getElementById('swimmerInterval').value;
            currentSettings.swimmerInterval = parseInt(swimmerInterval);
            document.getElementById('swimmerIntervalValue').textContent = swimmerInterval;
            updateSettings();
        }

        function updateUnderwatersEnabled() {
            const enabled = document.getElementById('underwatersEnabled').checked;
            currentSettings.underwatersEnabled = enabled;
            
            // Show/hide underwaters controls
            const controls = document.getElementById('underwatersControls');
            controls.style.display = enabled ? 'block' : 'none';
            
            // Update toggle labels
            const toggleOff = document.getElementById('toggleOff');
            const toggleOn = document.getElementById('toggleOn');
            
            if (enabled) {
                toggleOff.classList.remove('active');
                toggleOn.classList.add('active');
            } else {
                toggleOff.classList.add('active');
                toggleOn.classList.remove('active');
            }
            
            updateSettings();
        }

        function updateLightSize() {
            const lightSize = document.getElementById('lightSize').value;
            currentSettings.lightSize = parseFloat(lightSize);
            document.getElementById('lightSizeValue').textContent = lightSize;
            updateSettings();
        }

        function updateFirstUnderwaterDistance() {
            const distance = document.getElementById('firstUnderwaterDistance').value;
            currentSettings.firstUnderwaterDistance = parseInt(distance);
            document.getElementById('firstUnderwaterDistanceValue').textContent = distance;
            updateSettings();
        }

        function updateUnderwaterDistance() {
            const distance = document.getElementById('underwaterDistance').value;
            currentSettings.underwaterDistance = parseInt(distance);
            document.getElementById('underwaterDistanceValue').textContent = distance;
            updateSettings();
        }

        function updateHideAfter() {
            const hideAfter = document.getElementById('hideAfter').value;
            currentSettings.hideAfter = parseInt(hideAfter);
            document.getElementById('hideAfterValue').textContent = hideAfter;
            updateSettings();
        }

        function openColorPickerForUnderwater() {
            currentColorContext = 'underwater';
            openColorPicker();
        }

        function openColorPickerForSurface() {
            currentColorContext = 'surface';
            openColorPicker();
        }

        function updateNumSwimmers() {
            const numSwimmers = document.getElementById('numSwimmers').value;
            currentSettings.numSwimmers = parseInt(numSwimmers);
            document.getElementById('numSwimmersValue').textContent = numSwimmers;
            updateSettings();
        }

        function updateNumRounds() {
            const numRounds = document.getElementById('numRounds').value;
            currentSettings.numRounds = parseInt(numRounds);
            updateSettings();
        }

        function updateColorMode() {
            const colorMode = document.querySelector('input[name="colorMode"]:checked').value;
            currentSettings.colorMode = colorMode;
            updateVisualSelection();
            updateSettings();
        }

        function selectIndividualColors() {
            document.getElementById('individualColors').checked = true;
            updateColorMode();
        }

        function selectSameColor() {
            document.getElementById('sameColor').checked = true;
            updateColorMode();
        }

        function selectSameColorAndOpenPicker(event) {
            // Prevent the row click from triggering
            event.stopPropagation();

            // Select same color mode
            document.getElementById('sameColor').checked = true;
            updateColorMode();

            // Open color picker
            openColorPicker();
        }

        function updateVisualSelection() {
            const isIndividual = document.getElementById('individualColors').checked;
            const individualRow = document.getElementById('individualColorsRow');
            const sameColorRow = document.getElementById('sameColorRow');

            // Update visual feedback by highlighting the selected row
            if (isIndividual) {
                individualRow.style.backgroundColor = '#e3f2fd';
                individualRow.style.border = '2px solid #007bff';
                sameColorRow.style.backgroundColor = 'transparent';
                sameColorRow.style.border = '2px solid transparent';
            } else {
                individualRow.style.backgroundColor = 'transparent';
                individualRow.style.border = '2px solid transparent';
                sameColorRow.style.backgroundColor = '#e3f2fd';
                sameColorRow.style.border = '2px solid #007bff';
            }
        }

        function openColorPicker() {
            // Reset swimmer index (this is called from coach config)
            currentSwimmerIndex = -1;

            // Populate color grid if not already done
            populateColorGrid();

            // Show the custom color picker modal
            document.getElementById('customColorPicker').style.display = 'block';
        }

        function closeColorPicker() {
            document.getElementById('customColorPicker').style.display = 'none';
            currentSwimmerIndex = -1; // Reset swimmer index when closing
        }

        function populateColorGrid() {
            const colorGrid = document.getElementById('colorGrid');
            if (colorGrid.children.length > 0) return; // Already populated

            // Define a palette of common colors
            const colors = [
                '#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff',
                '#800000', '#008000', '#000080', '#808000', '#800080', '#008080',
                '#ff8000', '#80ff00', '#8000ff', '#ff0080', '#0080ff', '#ff8080',
                '#ffa500', '#90ee90', '#add8e6', '#f0e68c', '#dda0dd', '#afeeee',
                '#ffffff', '#c0c0c0', '#808080', '#404040', '#202020', '#000000'
            ];

            colors.forEach(color => {
                const colorDiv = document.createElement('div');
                colorDiv.style.cssText = `
                    width: 40px;
                    height: 40px;
                    background-color: ${color};
                    border: 2px solid #333;
                    border-radius: 50%;
                    cursor: pointer;
                    transition: transform 0.1s;
                `;
                colorDiv.onmouseover = () => colorDiv.style.transform = 'scale(1.1)';
                colorDiv.onmouseout = () => colorDiv.style.transform = 'scale(1)';
                colorDiv.onclick = () => selectColor(color);
                colorGrid.appendChild(colorDiv);
            });
        }

        function selectColor(color) {
            if (currentSwimmerIndex >= 0) {
                // Updating individual swimmer color
                swimmerSet[currentSwimmerIndex].color = hexToColorName(color);
                displaySwimmerSet();
                currentSwimmerIndex = -1; // Reset
            } else if (currentColorContext === 'underwater') {
                // Updating underwater color
                currentSettings.underwaterColor = color;
                document.getElementById('underwaterColorIndicator').style.backgroundColor = color;
                updateSettings();
            } else if (currentColorContext === 'surface') {
                // Updating surface color
                currentSettings.surfaceColor = color;
                document.getElementById('surfaceColorIndicator').style.backgroundColor = color;
                updateSettings();
            } else {
                // Updating coach config same color setting
                currentSettings.swimmerColor = color;
                document.getElementById('colorIndicator').style.backgroundColor = color;
                updateSettings();
            }
            
            currentColorContext = null; // Reset context
            closeColorPicker();
        }

        function updateSwimmerColor() {
            const swimmerColor = document.getElementById('swimmerColorPicker').value;
            currentSettings.swimmerColor = swimmerColor;

            // Update the color indicator
            document.getElementById('colorIndicator').style.backgroundColor = swimmerColor;

            updateSettings();
        }

        // Pacer status tracking variables
        let pacerStartTime = 0;
        let currentRound = 1;
        let statusUpdateInterval = null;
        let currentColorContext = null; // Track which color picker context we're in

        function togglePacer() {
            currentSettings.isRunning = !currentSettings.isRunning;

            // Update UI immediately for better responsiveness
            const status = currentSettings.isRunning ? "Pacer Started" : "Pacer Stopped";
            document.getElementById('status').textContent = status;
            document.getElementById('status').className = 'status ' + (currentSettings.isRunning ? 'running' : 'stopped');
            document.getElementById('toggleBtn').textContent = currentSettings.isRunning ? 'Stop Pacer' : 'Start Pacer';

            // Handle detailed status display
            const detailedStatus = document.getElementById('detailedStatus');
            if (currentSettings.isRunning) {
                // Starting pacer
                pacerStartTime = Date.now();
                currentRound = 1;
                detailedStatus.style.display = 'block';
                initializePacerStatus();
                startStatusUpdates();
            } else {
                // Stopping pacer
                detailedStatus.style.display = 'none';
                stopStatusUpdates();
            }

            // Try to notify server (will fail gracefully in standalone mode)
            fetch('/toggle', { method: 'POST' })
            .then(response => response.text())
            .then(result => {
                // Server responded, update status with server message
                document.getElementById('status').textContent = result;
            })
            .catch(error => {
                // Server not available (standalone mode), keep local status
                console.log('Running in standalone mode - server not available');
            });
        }

        function initializePacerStatus() {
            document.getElementById('currentRound').textContent = currentRound;
            document.getElementById('totalRounds').textContent = currentSettings.numRounds;
            document.getElementById('roundProgress').textContent = '0%';
            document.getElementById('activeSwimmers').textContent = '0';
            
            // Show initial delay countdown
            if (currentSettings.initialDelay > 0) {
                document.getElementById('nextEvent').textContent = `Starting in ${currentSettings.initialDelay}s`;
                document.getElementById('currentPhase').textContent = 'Initial Delay';
            } else {
                document.getElementById('nextEvent').textContent = 'Starting now';
                document.getElementById('currentPhase').textContent = 'Swimming';
            }
            
            document.getElementById('elapsedTime').textContent = '00:00';
        }

        function startStatusUpdates() {
            statusUpdateInterval = setInterval(updatePacerStatus, 1000); // Update every second
        }

        function stopStatusUpdates() {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
                statusUpdateInterval = null;
            }
        }

        function updatePacerStatus() {
            if (!currentSettings.isRunning) return;

            const elapsedSeconds = Math.floor((Date.now() - pacerStartTime) / 1000);
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            document.getElementById('elapsedTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            // Account for initial delay
            const initialDelaySeconds = currentSettings.initialDelay;
            const timeAfterInitialDelay = elapsedSeconds - initialDelaySeconds;

            // Check if we're still in the initial delay period
            if (timeAfterInitialDelay < 0) {
                // Still in initial delay phase
                document.getElementById('currentPhase').textContent = 'Initial Delay';
                document.getElementById('activeSwimmers').textContent = '0';
                document.getElementById('nextEvent').textContent = `Starting in ${Math.ceil(-timeAfterInitialDelay)}s`;
                document.getElementById('roundProgress').textContent = '0%';
                document.getElementById('currentRound').textContent = '1';
                return;
            }

            // Calculate current phase and progress (after initial delay)
            const paceSeconds = parseFloat(document.getElementById('pacePer50').value);
            const restSeconds = currentSettings.restTime;
            const totalRoundTime = paceSeconds + restSeconds;
            
            const timeInCurrentRound = timeAfterInitialDelay % totalRoundTime;
            const progressPercent = Math.floor((timeInCurrentRound / totalRoundTime) * 100);
            
            document.getElementById('roundProgress').textContent = `${progressPercent}%`;
            
            // Determine current phase
            if (timeInCurrentRound < paceSeconds) {
                document.getElementById('currentPhase').textContent = 'Swimming';
                document.getElementById('activeSwimmers').textContent = currentSettings.numSwimmers;
                const remainingSwimTime = paceSeconds - timeInCurrentRound;
                document.getElementById('nextEvent').textContent = `Rest in ${Math.ceil(remainingSwimTime)}s`;
            } else {
                document.getElementById('currentPhase').textContent = 'Rest Period';
                document.getElementById('activeSwimmers').textContent = '0';
                const remainingRestTime = totalRoundTime - timeInCurrentRound;
                document.getElementById('nextEvent').textContent = `Next round in ${Math.ceil(remainingRestTime)}s`;
            }
            
            // Update current round (after initial delay)
            const calculatedRound = Math.floor(timeAfterInitialDelay / totalRoundTime) + 1;
            if (calculatedRound !== currentRound && calculatedRound <= currentSettings.numRounds) {
                currentRound = calculatedRound;
                document.getElementById('currentRound').textContent = currentRound;
            }
            
            // Check if set is complete
            if (calculatedRound > currentSettings.numRounds) {
                document.getElementById('currentPhase').textContent = 'Set Complete!';
                document.getElementById('nextEvent').textContent = 'Finished';
                document.getElementById('activeSwimmers').textContent = '0';
            }
        }

        function createSet() {
            const configControls = document.getElementById('configControls');
            const swimmerSetDiv = document.getElementById('swimmerSet');
            const createSetBtn = document.getElementById('createSetBtn');

            // Check if we're currently showing the set (toggle mode)
            if (swimmerSetDiv.style.display === 'block') {
                // Currently showing set, switch back to config mode
                configControls.style.display = 'block';
                swimmerSetDiv.style.display = 'none';
                createSetBtn.textContent = 'Create Set';
                return;
            }

            // Create new set mode
            // Clear existing set
            swimmerSet = [];

            // Get current pace from the main settings
            const currentPace = parseFloat(document.getElementById('pacePer50').value);

            // Create swimmer configurations
            for (let i = 0; i < currentSettings.numSwimmers; i++) {
                // Determine color based on color mode
                let swimmerColor;
                if (currentSettings.colorMode === 'same') {
                    // Convert hex color to named color for consistency with existing system
                    swimmerColor = hexToColorName(currentSettings.swimmerColor);
                } else {
                    swimmerColor = swimmerColors[i];
                }

                swimmerSet.push({
                    id: i + 1,
                    color: swimmerColor,
                    pace: currentPace,
                    interval: i === 0 ? currentSettings.initialDelay : currentSettings.initialDelay + (i * currentSettings.swimmerInterval) // First swimmer uses initial delay, others add swimmer intervals
                });
            }

            // Display the set
            displaySwimmerSet();

            // Hide config controls and show swimmer set
            configControls.style.display = 'none';
            swimmerSetDiv.style.display = 'block';
            createSetBtn.textContent = 'Modify Set';
        }

        function displaySwimmerSet() {
            // Update set details in swim practice nomenclature
            const setDetails = document.getElementById('setDetails');
            const paceDistance = currentSettings.paceDistance;
            const avgPace = swimmerSet.length > 0 ? swimmerSet[0].pace : parseFloat(document.getElementById('pacePer50').value);
            const restTime = currentSettings.restTime;
            const numRounds = currentSettings.numRounds;

            setDetails.innerHTML = `${numRounds} x ${paceDistance}'s on the ${avgPace} with ${restTime} sec rest`;

            const swimmerList = document.getElementById('swimmerList');
            swimmerList.innerHTML = '';

            swimmerSet.forEach((swimmer, index) => {
                const row = document.createElement('div');
                row.className = 'swimmer-row';

                // Calculate delay from previous swimmer
                let delayFromPrevious;
                if (index === 0) {
                    delayFromPrevious = currentSettings.initialDelay; // First swimmer shows initial delay
                } else {
                    delayFromPrevious = currentSettings.swimmerInterval; // Others show interval between swimmers
                }

                row.innerHTML = `
                    <div class="swimmer-color" style="background-color: ${colorHex[swimmer.color]}"
                         onclick="cycleSwimmerColor(${index})" title="Click to change color"></div>
                    <div class="swimmer-info">Swimmer ${swimmer.id}</div>
                    <div>Delay: ${delayFromPrevious}s</div>
                    <div>Pace: <input type="number" class="swimmer-pace-input" value="${swimmer.pace}"
                         min="20" max="300" step="0.5" onchange="updateSwimmerPace(${index}, this.value)"> sec</div>
                `;

                swimmerList.appendChild(row);
            });
        }

        function cycleSwimmerColor(swimmerIndex) {
            // Set the current swimmer being edited and open color picker
            currentSwimmerIndex = swimmerIndex;
            populateColorGrid();
            document.getElementById('customColorPicker').style.display = 'block';
        }

        function updateSwimmerPace(swimmerIndex, newPace) {
            swimmerSet[swimmerIndex].pace = parseFloat(newPace);
        }

        function updateSettings() {
            fetch('/setSpeed', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `speed=${currentSettings.speed}`
            }).catch(error => {
                console.log('Speed update - server not available (standalone mode)');
            });

            fetch('/setPulseWidth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `pulseWidth=${currentSettings.pulseWidth}`
            }).catch(error => {
                console.log('Pulse width update - server not available (standalone mode)');
            });

            fetch('/setStripLength', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `stripLength=${currentSettings.stripLength}`
            }).catch(error => {
                console.log('Strip length update - server not available (standalone mode)');
            });

            fetch('/setLedsPerMeter', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `ledsPerMeter=${currentSettings.ledsPerMeter}`
            }).catch(error => {
                console.log('LEDs per meter update - server not available (standalone mode)');
            });

            fetch('/setRestTime', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `restTime=${currentSettings.restTime}`
            }).catch(error => {
                console.log('Rest time update - server not available (standalone mode)');
            });

            fetch('/setPaceDistance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `paceDistance=${currentSettings.paceDistance}`
            }).catch(error => {
                console.log('Pace distance update - server not available (standalone mode)');
            });

            fetch('/setSwimmerInterval', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `swimmerInterval=${currentSettings.swimmerInterval}`
            }).catch(error => {
                console.log('Swimmer interval update - server not available (standalone mode)');
            });

            fetch('/setNumSwimmers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `numSwimmers=${currentSettings.numSwimmers}`
            }).catch(error => {
                console.log('Number of swimmers update - server not available (standalone mode)');
            });

            fetch('/setNumRounds', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `numRounds=${currentSettings.numRounds}`
            }).catch(error => {
                console.log('Number of rounds update - server not available (standalone mode)');
            });
        }

        // Initialize
        updateCalculations();
        updateVisualSelection();
    </script>
</body>
</html>
<!-- ========== SYNC MARKER: END ESP32 HTML ========== -->